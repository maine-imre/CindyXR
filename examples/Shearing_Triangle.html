<!DOCTYPE html>
<html>

<head>
<title>Shearing Triangle DEMO</title>
<meta charset="UTF-8">
    <script type="text/javascript" src="https://maine-imre.github.io/CindyXR-Interactions/deploy/Cindy.js"></script>
    <script type="text/javascript" src="https://maine-imre.github.io/CindyXR-Interactions/deploy/Cindy3D.js"></script>
    <script type="text/javascript" src="https://maine-imre.github.io/CindyXR-Interactions/deploy/CindyXR.js"></script>
<script id="csinit" type="text/x-cindyscript">

    initxrcindy3d(referencemode->"local");

        tolerance = .1;

    xrrenderfunction() := (
		begin3d();

        //environment parameters
        size3d(.1);

		//set bg color
			background3d([.9,.9,.9]);

	    //store vertex values as vectors
        //note that this should eventually be switched over to cindy3d geometry
        a=[1,0,0,1];
        b=[0,0,0,1];
        cDefault = [0,1,0,1];
        c = cDefault;

	   //setup controller - 1 indexed
	    xrControllers =  getxrinputsources();
        //grab the first available controllers
        inputsourceL = xrControllers_1;
        inputsourceR = xrControllers_2;

        // in a new plugin design, these functions should be moved outside the render function.
        // #1 Draw Controller Position, color appropriate for buttons.
        if (inputsourceL.targetRayMode == "tracked-pointer",
            // Draw a ball at the position of the controller and color it depending on whether button 1 is pressed.
            //buttons_1 is "squeeze button" for vive, but not quest.
            //buttons_1 is "squeeze button" for vive, but not quest.
            isSelectedL = inputsourceL.gamepad.buttons_3.pressed;
            isSqueezedL = inputsourceL.gamepad.buttons_1.pressed;
            controllerColor = [0,0,0];
            if(isSelectedL, controllerColor = controllerColor + [1,0,0]);
            if(isSqueezedL, controllerColor = controllerColor + [0,1,0]);
            //reads the position in homogeneous coordinates
            //homogeneous coordinates end in 1 if tracked, zero if not tracked
            draw3d(inputsourceL.gripSpaceTransform.position, color->controllerColor, size->2);

            //use this controller to move the vertex 'c' if it is proximal to to the line.
            //TODO drag point c instead of reassigning position.
            positionL  = inputsourceL.gripSpaceTransform.position;

            //project the controllers position onto the line
            abHat = (a-b)/|a-b|;
            controllerToLine =((positionL-cDefault)*abHat)*abHat + cDefault;

            closeEnough = |positionL - controllerToLine| < tolerance;

            //if sufficiently close and squeezing, project the controller onto the line.
            if(isSqueezedL, if(closeEnough, c = controllerToLine));
        );

        // #2 Draw Controller Position, color appropriate for buttons.
        if (inputsourceR.targetRayMode == "tracked-pointer",
            // Draw a ball at the position of the controller and color it depending on whether button 1 is pressed.
            //buttons_1 is "squeeze button" for vive, but not quest.
            //buttons_1 is "squeeze button" for vive, but not quest.
            isSelectedR = inputsourceR.gamepad.buttons_3.pressed;
            isSqueezedR = inputsourceR.gamepad.buttons_1.pressed;
            controllerColor = [0,0,0];
            if(isSelectedR, controllerColor = controllerColor + [1,0,0]);
            if(isSqueezedR, controllerColor = controllerColor + [0,1,0]);

            //reads the position in homogeneous coordinates
            //homogeneous coordinates end in 1 if tracked, zero if not tracked
            draw3d(inputsourceR.gripSpaceTransform.position, color->controllerColor, size->2);
        );

		//draw parallel lines
			draw3d((a-b)*100+a,(a-b)*(-100)+a,size->.1, color->[.7,.7,.7]); //line through ab
			draw3d((a-b)*100+c,(a-b)*(-100)+c,size->.1, color->[.7,.7,.7]); //line through c parallel to ab

		//draw line segments ab, bc, ac
			draw3d(a,b, color->[0,0,0]);
			draw3d(b,c, color->[0,0,0]);
			draw3d(a,c, color->[0,0,0]);

		//draw points abc
			draw3d(a, size->.3, color->[1,0,0]);
			draw3d(b, size->.3, color->[0,1,0]);
			draw3d(c, size->.3, color->[0,0,1]);
			draw3d(c, size->.3, color->[0,0,1]);


		//draw triangle abc
			fillpoly3d([a,b,c], color->[.9,.9,.9]);
		end3d();
    );
    xr(xrrenderfunction());
</script>

<script type="text/javascript">
    var cdy = CindyJS({
        scripts: "cs*",
        angleUnit: "Â°",
        exclusive: "true",
        ports: [
            {id: "CSCanvas", background: "rgb(200,176,192)"}
        ],
        csconsole: false,
        use: [
            "Cindy3D", "CindyXR"
        ],
        autoplay: false,
        behavior: []
    });
</script>
</head>

<body>
    <a href="https://maine-imre.github.io/CindyXR-Interactions/">CindyXR Interactions Home</a>
    <canvas id="Cindy3D" style="border: none;" width="700" height="700"></canvas>
    <div id="CSCanvas" style="width:50px; height:50px; border:none"></div>
</body>

</html>
