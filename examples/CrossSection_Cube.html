<!DOCTYPE html>
<html>

<head>
    <title>Cross-sect Cube</title>
    <meta charset="UTF-8">
    <script type="text/javascript" src="https://maine-imre.github.io/CindyXR-Interactions/deploy/Cindy.js"></script>
    <script type="text/javascript" src="https://maine-imre.github.io/CindyXR-Interactions/deploy/Cindy3D.js"></script>
    <script type="text/javascript" src="https://maine-imre.github.io/CindyXR-Interactions/deploy/CindyXR.js"></script>
    <script id="csinit" type="text/x-cindyscript">

    initxrcindy3d(referencemode->"local");
        tolerance = 1;

    drawQuad3d(x,y,z,w) := (
		//draw line segments
			draw3d(x,y, color->[0,0,0]);
			draw3d(y,z, color->[0,0,0]);
			draw3d(z,w, color->[0,0,0]);
			draw3d(w,x, color->[0,0,0]);
		//draw quad x,y,z,w
			fillpoly3d([x,y,z,w], color->[.9,.9,.9]);
    );

    xrrenderfunction() := (

    begin3d();
        size3d(.1);


    //set bg color
			background3d([.9,.9,.9]);

		//store point values as vectors
		//note that this should eventually be switched over to cindy3d geometry
			a = [0,0,0];
			b = [1,0,0];
			c = [1,1,0];
			d = [0,1,0];
			e = [0,0,1];
			f = [0,1,1];
			g = [1,0,1];
			h = [1,1,1];


    	   //setup controller - 1 indexed
	    xrControllers =  getxrinputsources();
        //grab the first available controllers
        inputsourceL = xrControllers_1;
        inputsourceR = xrControllers_2;

        // in a new plugin design, these functions should be moved outside the render function.
        // #1 Draw Controller Position, color appropriate for buttons.
        if (inputsourceL.targetRayMode == "tracked-pointer",
            // Draw a ball at the position of the controller and color it depending on whether button 1 is pressed.
            //buttons_1 is "squeeze button" for vive and quest.
            //buttons_3 is "select button" for vive, but not quest.
            isSelectedL = inputsourceL.gamepad.buttons_3.pressed;
            isSqueezedL = inputsourceL.gamepad.buttons_1.pressed;
            controllerColor = [0,0,0];
            if(isSelectedL, controllerColor = controllerColor + [1,0,0]);
            if(isSqueezedL, controllerColor = controllerColor + [0,1,0]);
            //reads the position in homogeneous coordinates
            //homogeneous coordinates end in 1 if tracked, zero if not tracked
            draw3d(inputsourceL.gripSpaceTransform.position, color->controllerColor, size->.5);

            //use this controller to move the vertex 'c' if it is proximal to to the line.
            //TODO drag point c instead of reassigning position.
            positionL  = inputsourceL.gripSpaceTransform.position;
        );

        // Use the 2nd controller to draw an intersecting polygon
        // #2 Draw Controller Position, color appropriate for buttons.
        if (inputsourceR.targetRayMode == "tracked-pointer",
            // Draw a ball at the position of the controller and color it depending on whether button 1 is pressed.
            //buttons_1 is "squeeze button" for vive and quest.
            //buttons_3 is "select button" for vive, but not quest.
            isSelectedR = inputsourceR.gamepad.buttons_3.pressed;
            isSqueezedR = inputsourceR.gamepad.buttons_1.pressed;
            controllerColor = [0,0,0];
            if(isSelectedR, controllerColor = controllerColor + [1,0,0]);
            if(isSqueezedR, controllerColor = controllerColor + [0,1,0]);

            //reads the position in homogeneous coordinates
            //homogeneous coordinates end in 1 if tracked, zero if not tracked
            draw3d(inputsourceR.gripSpaceTransform.position, color->controllerColor, size->.5);

            //grab the height of the controller.
            height = inputsourceR.gripSpaceTransform.position.y;

            // calculate and draw the intersecting plane
            //TODO generalize to multiple angles
            j = [0,height,0];
            k = [1,height,0];
            l = [1,height,1];
            m = [0,height,1];

            if(!isSelectedR & (height > 0 & height < 1), fillpoly3d([j,k,l,m],color -> [.5,.5,.5]));
        );


        if(isSelectedR,
        //draw faces
        //TODO these need transparencies.
            drawQuad3d(a,b,c,d);
            drawQuad3d(a,b,g,e);
            drawQuad3d(a,d,f,e);
            drawQuad3d(h,g,e,f);
            drawQuad3d(h,c,d,f);
            drawQuad3d(h,c,b,g);

		//draw points abc
			draw3d(a, size->.3, color->[1,1,1]);
			draw3d(b, size->.3, color->[1,1,1]);
			draw3d(c, size->.3, color->[1,1,1]);
			draw3d(d, size->.3, color->[1,1,1]);
			draw3d(e, size->.3, color->[1,1,1]);
			draw3d(f, size->.3, color->[1,1,1]);
			draw3d(g, size->.3, color->[1,1,1]);
			draw3d(h, size->.3, color->[1,1,1]);
		);

		end3d();
    );
    xr(xrrenderfunction());
</script>

    <script type="text/javascript">
        var cdy = CindyJS({
            scripts: "cs*",
            angleUnit: "Â°",
            exclusive: "true",
            geometry: [
                {alpha: 0, color: [1, 0, 0], labeled: false, name: "A", pinned: true, type: "Free", pos: [-5,-2.8,1]},
                {alpha: 0, color: [1, 0, 0], labeled: false, name: "B", pinned: true, type: "Free", pos: [5,-2.8,1]}
            ],
            ports: [
                {id: "CSCanvas", background: "rgb(200,176,192)"}
            ],
            csconsole: false,
            use: [
                "Cindy3D", "CindyXR"
            ],
            autoplay: false,
            behavior: []
        });
    </script>
</head>

<body>
	<a href="https://maine-imre.github.io/CindyXR-Interactions/">CindyXR Interactions Home</a>
    <b>Left Controller</b>
    Move up and down to cross-sect the cube.
    Press "Select" to view the cube.
    <b>Right Controller</b>
    N/A
<canvas id="Cindy3D" style="border: none;" width="1000" height="500"></canvas>
<div id="CSCanvas" style="width:50px; height:50px; border:none"></div>
</body>

</html>
